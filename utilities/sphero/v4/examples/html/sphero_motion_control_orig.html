
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Sphero Motion Control</title><meta name="generator" content="MATLAB 8.3"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2014-09-12"><meta name="DC.source" content="sphero_motion_control_orig.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Sphero Motion Control</h1><!--introduction--><p>This example shows you how to control the motion of a Sphero using the Sphero Connectivity Package</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Introduction</a></li><li><a href="#2">Prerequisites</a></li><li><a href="#3">Connect to Sphero</a></li><li><a href="#6">Speify the points to be traversed</a></li></ul></div><h2>Introduction<a name="1"></a></h2><p>In this example, you will use the data received from the onboard sensors of the Sphero to perform closed loop control of the motion of the Sphero. We will provide a set of points that we want the Sphero to pass through. The data from the sensors will be used to estimate the current position of the Sphero, which is used by the controller to compute the speed and angle to which the Sphero will be commanded to</p><h2>Prerequisites<a name="2"></a></h2><p>It is helpful to complete the <a href="matlab:showdemo('sphero_getting_started')">Getting Started with Sphero Connectivity Package</a> example</p><h2>Connect to Sphero<a name="3"></a></h2><pre class="codeinput">sph = sphero();
result = ping(sph);
</pre><p>You can specify the Bluetooth name of the device that you would like to connect to, instead of searching for all the paired devices.</p><p>Turn on handshaking in order to make sure that the Sphero is able to receive and respond to messages. And calibrate the orientation of the Sphero so that it points in the desired direction, before we start moving it around</p><pre class="codeinput">sph.Handshake = 1;  <span class="comment">%Turn on handshaking</span>
calibrate(sph, 0); <span class="comment">%Calibrate the orientation of the sphero</span>
</pre><h2>Speify the points to be traversed<a name="6"></a></h2><pre class="codeinput">load(<span class="string">'path2.mat'</span>);

listnum = length(xdeslist);

<span class="comment">% Specify the other parameters that are used in controlling the Sphero</span>
tfinal = 60;
stopRadius = 3;
maxspeed = 150; minspeed = -150; restartspeed = 50;

Kp = 1; Ki = 0.1; Kd = 0.1;
<span class="comment">% xdes = -20; ydes = 100;</span>



<span class="comment">% xdeslist = posdes(:, 1);</span>
<span class="comment">% ydeslist = posdes(:, 2);</span>



<span class="comment">% t = 0:100;</span>




[x, y, ~, ~, groundspeed] = readLocator(sph);
<span class="comment">% prevt = 0;</span>

distarr = []; xlog = []; ylog = []; speedarr = [];

xdes = xdeslist(1);
ydes = ydeslist(1);
control_sphero_motion(xdes, ydes, x, y, groundspeed, Kp, Ki, Kd, stopRadius, maxspeed, minspeed, restartspeed, 1);

figure(1)
clf
hold <span class="string">on</span>
plot(x, y, <span class="string">'r*'</span>)
plot(xdeslist, ydeslist, <span class="string">'kx'</span>)
hold <span class="string">off</span>

speed = [];
dist = pdist([xdes ydes; x y]); <span class="comment">%Distance or the error</span>

t0 = cputime;
<span class="keyword">while</span>(cputime-t0&lt;tfinal) &amp;&amp; idx&lt;=listnum
xdes = xdeslist(idx);
ydes = ydeslist(idx);
dist = pdist([xdes ydes; x y]); <span class="comment">%Distance or the error</span>

control_sphero_motion(xdes, ydes, x, y, groundspeed, Kp, Ki, Kd, stopRadius, maxspeed, minspeed, restartspeed, 1);

<span class="keyword">while</span> dist&gt;stopRadius <span class="comment">%|| speed~=0</span>
<span class="comment">%     if t&gt;5</span>
<span class="comment">%         keyboard</span>
<span class="comment">%     end</span>


    [speed, angle, dist] = control_sphero_motion(xdes, ydes, x, y, groundspeed, Kp, Ki, Kd, stopRadius, maxspeed, minspeed, restartspeed, 0);

    result = roll(sph, speed, angle);



<span class="comment">%     x = x + speed*(t-prevt)*sin(angle)*0.7;</span>
<span class="comment">%     y = y + speed*(t-prevt)*cos(angle)*0.7;</span>

<span class="comment">%     prevt = t;</span>
<span class="comment">%     plot(x, y, 'r*')</span>

    [x, y,~, ~, groundspeed] = readLocator(sph);
    dist = pdist(double([xdes ydes; x y])); <span class="comment">%Distance or the error</span>
    xlog(end+1) = x;
    ylog(end+1) = y;
    distarr(end+1) = dist;
    speedarr(end+1) = speed;



<span class="keyword">end</span>
idx = idx+1;
<span class="keyword">end</span>
roll(sph, 0, angle)
<span class="comment">% brake(sph);</span>

[x, y] = readLocator(sph);
distend = pdist([xdes ydes; x y]); <span class="comment">%Distance or the error</span>

hold <span class="string">on</span>
plot(xlog, ylog, <span class="string">'r*'</span>);
hold <span class="string">off</span>

figure(2)
plot(distarr)

control_sphero_motion(xdes, ydes, x, y, groundspeed, Kp, Ki, Kd, stopRadius, maxspeed, minspeed, restartspeed, 1);


sleep(sph);
clear <span class="string">sph</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Sphero Motion Control
% This example shows you how to control the motion of a Sphero using the 
% Sphero Connectivity Package
%% Introduction
% In this example, you will use the data received from the onboard sensors
% of the Sphero to perform closed loop control of the motion of the Sphero.
% We will provide a set of points that we want the Sphero to pass through. 
% The data from the sensors will be used to estimate the current position 
% of the Sphero, which is used by the controller to compute the speed and
% angle to which the Sphero will be commanded to
%
%% Prerequisites
% It is helpful to complete the <matlab:showdemo('sphero_getting_started') Getting Started with Sphero
% Connectivity Package> example
%
%% Connect to Sphero
sph = sphero();
result = ping(sph);
%%
% You can specify the Bluetooth name of the device that you would like to
% connect to, instead of searching for all the paired devices.
%%
% Turn on handshaking in order to make sure that the Sphero is able to 
% receive and respond to messages. And calibrate the orientation of the
% Sphero so that it points in the desired direction, before we start moving
% it around
sph.Handshake = 1;  %Turn on handshaking 
calibrate(sph, 0); %Calibrate the orientation of the sphero

%% Speify the points to be traversed
load('path2.mat');

listnum = length(xdeslist);

% Specify the other parameters that are used in controlling the Sphero
tfinal = 60;
stopRadius = 3; 
maxspeed = 150; minspeed = -150; restartspeed = 50;

Kp = 1; Ki = 0.1; Kd = 0.1;
% xdes = -20; ydes = 100;



% xdeslist = posdes(:, 1);
% ydeslist = posdes(:, 2);



% t = 0:100;




[x, y, ~, ~, groundspeed] = readLocator(sph);
% prevt = 0;

distarr = []; xlog = []; ylog = []; speedarr = [];

xdes = xdeslist(1);
ydes = ydeslist(1);
control_sphero_motion(xdes, ydes, x, y, groundspeed, Kp, Ki, Kd, stopRadius, maxspeed, minspeed, restartspeed, 1);

figure(1)
clf
hold on
plot(x, y, 'r*')
plot(xdeslist, ydeslist, 'kx')
hold off

speed = [];
dist = pdist([xdes ydes; x y]); %Distance or the error

t0 = cputime;
while(cputime-t0<tfinal) && idx<=listnum
xdes = xdeslist(idx);
ydes = ydeslist(idx);
dist = pdist([xdes ydes; x y]); %Distance or the error

control_sphero_motion(xdes, ydes, x, y, groundspeed, Kp, Ki, Kd, stopRadius, maxspeed, minspeed, restartspeed, 1);

while dist>stopRadius %|| speed~=0
%     if t>5
%         keyboard
%     end
    
    
    [speed, angle, dist] = control_sphero_motion(xdes, ydes, x, y, groundspeed, Kp, Ki, Kd, stopRadius, maxspeed, minspeed, restartspeed, 0);
    
    result = roll(sph, speed, angle);
    
    

%     x = x + speed*(t-prevt)*sin(angle)*0.7;
%     y = y + speed*(t-prevt)*cos(angle)*0.7;
    
%     prevt = t;
%     plot(x, y, 'r*')

    [x, y,~, ~, groundspeed] = readLocator(sph);
    dist = pdist(double([xdes ydes; x y])); %Distance or the error
    xlog(end+1) = x;
    ylog(end+1) = y;
    distarr(end+1) = dist;
    speedarr(end+1) = speed;
    
    
    
end
idx = idx+1;
end
roll(sph, 0, angle)
% brake(sph);

[x, y] = readLocator(sph);
distend = pdist([xdes ydes; x y]); %Distance or the error

hold on
plot(xlog, ylog, 'r*');
hold off

figure(2)
plot(distarr)

control_sphero_motion(xdes, ydes, x, y, groundspeed, Kp, Ki, Kd, stopRadius, maxspeed, minspeed, restartspeed, 1);

    
sleep(sph);
clear sph
##### SOURCE END #####
--></body></html>